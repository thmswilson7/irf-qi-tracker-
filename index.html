<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IRF QI Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    h1 { font-size: 1.5em; }
    .task { margin-bottom: 15px; }
    .scores { display: flex; gap: 10px; margin-top: 5px; }
    select, input[type="text"], textarea { padding: 5px; font-size: 1em; }
    label { margin-right: 10px; }
    textarea { width: 100%; height: 120px; margin-top: 10px; font-family: monospace; white-space: pre-wrap; }
    button { margin-top: 10px; padding: 8px 15px; font-size: 1em; cursor: pointer; }
    .section { border: 1px solid #ccc; padding: 10px; margin-top: 20px; border-radius: 5px; }
    .checkbox-group label { display: inline-block; margin-right: 15px; }
  </style>
</head>
<body>
  <h1>IRF QI Tracker</h1>
  <label>Enter PIN: <input type="password" id="pinInput" /></label>
  <button onclick="login()">Login</button>

  <div id="app" style="display:none;">
    <label>Patient:
      <select id="patientSelector"></select>
    </label>

    <div id="tasks"></div>

    <div class="section">
      <label for="patientGoal"><strong>Patient Goal (free text):</strong></label><br/>
      <textarea id="patientGoal" placeholder="Enter patient goal here..."></textarea>
    </div>

    <div class="section checkbox-group">
      <strong>Progress Status:</strong><br/>
      <label><input type="radio" name="progressStatus" value="Progressing" checked /> Progressing</label>
      <label><input type="radio" name="progressStatus" value="Not Progressing" /> Not Progressing</label>
    </div>

    <div class="section checkbox-group">
      <strong>Barriers to Goals:</strong><br/>
      <label><input type="checkbox" class="barrier" value="Weakness" checked /> Weakness</label>
      <label><input type="checkbox" class="barrier" value="Deconditioning" checked /> Deconditioning</label>
      <label><input type="checkbox" class="barrier" value="Balance Impairment" checked /> Balance Impairment</label>
      <label><input type="checkbox" class="barrier" value="Limited ROM" checked /> Limited ROM</label>
      <label><input type="checkbox" class="barrier" value="Pain" checked /> Pain</label>
    </div>

    <div class="section checkbox-group">
      <strong>Interventions:</strong><br/>
      <label><input type="checkbox" class="intervention" value="Therapeutic Exercise" checked /> Therapeutic Exercise</label>
      <label><input type="checkbox" class="intervention" value="Therapeutic Activity" checked /> Therapeutic Activity</label>
      <label><input type="checkbox" class="intervention" value="ADL Training" checked /> ADL Training</label>
    </div>

    <button onclick="generateSummary()">Generate Summary</button>

    <textarea id="summaryOutput" readonly placeholder="Generated summary will appear here..."></textarea>
    <button onclick="copySummary()">Copy Summary</button>

    <div class="section" style="margin-top:30px;">
      <label for="udsSnippet"><strong>UDS Note Snippet (Progress, Barriers, Interventions):</strong></label>
      <textarea id="udsSnippet" readonly placeholder="This snippet can be copied into UDS/Rehab Connect notes..."></textarea>
      <button onclick="copyUdsSnippet()">Copy UDS Snippet</button>
    </div>
  </div>

  <script>
    const correctPin = '1234';
    const patients = ['Room 101', 'Room 102', 'Room 103'];
    const tasks = [
      'Eating',
      'Oral Hygiene',
      'Upper Body Dressing',
      'Lower Body Dressing',
      'Footwear',
      'Shower',
      'Toilet Hygiene',
      'Toilet Transfers'
    ];
    const scores = {
      1: 'Dependent',
      2: 'Substantial A',
      3: 'Partial A',
      4: 'Supervision/Touch A',
      5: 'Setup A',
      6: 'Independent',
      88: 'Not Attempted',
      7: 'Refused',
      9: 'Not Applicable'
    };

    function storageKey(patient, task, type) {
      return `qi_${patient}_${task}_${type}`;
    }

    function saveScore(patient, task, type, value) {
      try {
        localStorage.setItem(storageKey(patient, task, type), value);
      } catch(e) {
        console.warn('LocalStorage error:', e);
      }
    }

    function loadScore(patient, task, type) {
      try {
        return localStorage.getItem(storageKey(patient, task, type));
      } catch(e) {
        return null;
      }
    }

    function login() {
      const pin = document.getElementById('pinInput').value;
      if (pin === correctPin) {
        document.getElementById('app').style.display = 'block';
        document.getElementById('pinInput').style.display = 'none';
        document.querySelector('button[onclick="login()"]').style.display = 'none';
        document.getElementById('patientSelector').focus();
      } else {
        alert('Incorrect PIN');
      }
    }

    function scoreOptions() {
      return Object.entries(scores)
        .map(([val, label]) => `<option value="${val}">${val} - ${label}</option>`)
        .join('');
    }

    function render() {
      const selector = document.getElementById('patientSelector');
      patients.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        selector.appendChild(opt);
      });

      const tasksDiv = document.getElementById('tasks');
      tasksDiv.innerHTML = ''; // Clear previous
      tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';

        div.innerHTML = `<strong>${task}</strong>
          <div class="scores">
            <label>Eval Score: <select class="evalScore">${scoreOptions()}</select></label>
            <label>Discharge Goal: <select class="dischargeScore">${scoreOptions()}</select></label>
            <label>Current Score: <select class="currentScore">${scoreOptions()}</select></label>
          </div>`;
        tasksDiv.appendChild(div);
      });
    }

    function loadPatientData(patient) {
      const tasksDiv = document.getElementById('tasks');
      const taskDivs = tasksDiv.getElementsByClassName('task');

      for (const div of taskDivs) {
        const taskName = div.querySelector('strong').textContent;

        // Load Eval Score
        const evalSelect = div.querySelector('.evalScore');
        const evalVal = loadScore(patient, taskName, 'eval');
        if (evalVal) evalSelect.value = evalVal;
        evalSelect.onchange = () => saveScore(patient, taskName, 'eval', evalSelect.value);

        // Load Discharge Goal Score
        const dischargeSelect = div.querySelector('.dischargeScore');
        const dischargeVal = loadScore(patient, taskName, 'discharge');
        if (dischargeVal) dischargeSelect.value = dischargeVal;
        dischargeSelect.onchange = () => saveScore(patient, taskName, 'discharge', dischargeSelect.value);

        // Load Current Score and save on change too!
        const currentSelect = div.querySelector('.currentScore');
        const currentVal = loadScore(patient, taskName, 'current');
        if (currentVal) currentSelect.value = currentVal;
        currentSelect.onchange = () => saveScore(patient, taskName, 'current', currentSelect.value);
      }

      // Load other saved data if you want (patient goal, progress, barriers, interventions) here if you want persistence later.
    }

    document.getElementById('patientSelector').addEventListener('change', (e) => {
      loadPatientData(e.target.value);
    });

    function generateSummary() {
      const patient = document.getElementById('patientSelector').value;
      if (!patient) {
        alert('Please select a patient.');
        return;
      }

      const tasksDiv = document.getElementById('tasks');
      const taskDivs = tasksDiv.getElementsByClassName('task');

      let summary = '';

      for (const div of taskDivs) {
        const taskName = div.querySelector('strong').textContent;
        const evalVal = div.querySelector('.evalScore').value;
        const dischargeVal = div.querySelector('.dischargeScore').value;
        const currentVal = div.querySelector('.currentScore').value;

        if (evalVal || dischargeVal || currentVal) {
          const evalLabel = scores[evalVal] || evalVal || 'N/A';
          const dischargeLabel = scores[dischargeVal] || dischargeVal || 'N/A';
          const currentLabel = scores[currentVal] || currentVal || 'N/A';

          summary += `${taskName}:\n  Eval Score: ${evalVal} (${evalLabel})\n  Discharge Goal: ${dischargeVal} (${dischargeLabel})\n  Current Score: ${currentVal} (${currentLabel})\n\n`;
        }
      }

      // Patient Goal
      const patientGoal = document.getElementById('patientGoal').value.trim();
      if (patientGoal) {
        summary += `Patient Goal:\n  ${patientGoal}\n\n`;
      }

      // Progress Status
      const progressElems = document.getElementsByName('progressStatus');
      let progressStatus = 'Progressing';
      for (const el of progressElems) {
        if (el.checked) {
          progressStatus = el.value;
          break;
        }
      }
      summary += `Progress Status: ${progressStatus}\n\n`;

      // Barriers
      const barrierElems = document.querySelectorAll('.barrier');
      const selectedBarriers = [];
      barrierElems.forEach(el => {
        if (el.checked) selectedBarriers.push(el.value);
      });
      summary += `Barriers to Goals: ${selectedBarriers.join(', ') || 'None'}\n\n`;

      // Interventions
      const interventionElems = document.querySelectorAll('.intervention');
      const selectedInterventions = [];
      interventionElems.forEach(el => {
        if (el.checked) selectedInterventions.push(el.value);
      });
      summary += `Interventions: ${selectedInterventions.join(', ') || 'None'}\n`;

      document.getElementById('summaryOutput').value = summary;

      // Also create UDS snippet for quick copy/paste
      const udsSnippet = 
        `Progress Status: ${progressStatus}\n` +
        `Barriers to Goals: ${selectedBarriers.join(', ') || 'None'}\n` +
        `Interventions: ${selectedInterventions.join(', ') || 'None'}`;

      document.getElementById('udsSnippet').value = udsSnippet;
    }

    function copySummary() {
      const summaryText = document.getElementById('summaryOutput').value;
      if (!summaryText) {
        alert('Please generate the summary first.');
        return;
      }
      navigator.clipboard.writeText(summaryText)
        .then(() => alert('Summary copied to clipboard!'))
        .catch(() => alert('Failed to copy summary.'));
    }

    function copyUdsSnippet() {
      const snippetText = document.getElementById('udsSnippet').value;
      if (!snippetText) {
        alert('Please generate the summary first.');
        return;
      }
      navigator.clipboard.writeText(snippetText)
        .then(() => alert('UDS snippet copied to clipboard!'))
        .catch(() => alert('Failed to copy snippet.'));
    }

    // Initial render
    render();
  </script>
</body>
</html>
