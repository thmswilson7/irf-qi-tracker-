<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IRF QI Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    h1 { font-size: 1.5em; }
    .task { margin-bottom: 15px; }
    .scores { display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
    select, input[type="text"], textarea { padding: 5px; font-size: 1em; }
    label { margin-right: 10px; }
    textarea { width: 100%; height: 120px; margin-top: 10px; font-family: monospace; white-space: pre-wrap; }
    button { margin-top: 10px; padding: 8px 15px; font-size: 1em; cursor: pointer; }
    .section { border: 1px solid #ccc; padding: 10px; margin-top: 20px; border-radius: 5px; }
    .checkbox-group label { display: inline-block; margin-right: 15px; }
    .scores label { min-width: 120px; }
  </style>
</head>
<body>
  <h1>IRF QI Tracker</h1>
  <label>Enter PIN: <input type="password" id="pinInput" /></label>
  <button onclick="login()">Login</button>

  <div id="app" style="display:none;">
    <label>Patient:
      <select id="patientSelector" onchange="onPatientChange()"></select>
    </label>

    <div id="tasks"></div>

    <div class="section">
      <label for="patientGoal"><strong>Patient Goal (free text):</strong></label><br/>
      <textarea id="patientGoal" placeholder="Enter patient goal here..." oninput="savePatientGoal()"></textarea>
    </div>

    <div class="section checkbox-group">
      <strong>Progress Status:</strong><br/>
      <label><input type="radio" name="progressStatus" value="Progressing" checked onchange="saveProgressStatus()" /> Progressing</label>
      <label><input type="radio" name="progressStatus" value="Not Progressing" onchange="saveProgressStatus()" /> Not Progressing</label>
    </div>

    <div class="section checkbox-group">
      <strong>Barriers to Goals:</strong><br/>
      <label><input type="checkbox" class="barrier" value="Weakness" checked onchange="saveBarriers()" /> Weakness</label>
      <label><input type="checkbox" class="barrier" value="Deconditioning" checked onchange="saveBarriers()" /> Deconditioning</label>
      <label><input type="checkbox" class="barrier" value="Balance Impairment" checked onchange="saveBarriers()" /> Balance Impairment</label>
      <label><input type="checkbox" class="barrier" value="Limited ROM" checked onchange="saveBarriers()" /> Limited ROM</label>
      <label><input type="checkbox" class="barrier" value="Pain" checked onchange="saveBarriers()" /> Pain</label>
    </div>

    <div class="section checkbox-group">
      <strong>Interventions:</strong><br/>
      <label><input type="checkbox" class="intervention" value="Therapeutic Exercise" checked onchange="saveInterventions()" /> Therapeutic Exercise</label>
      <label><input type="checkbox" class="intervention" value="Therapeutic Activity" checked onchange="saveInterventions()" /> Therapeutic Activity</label>
      <label><input type="checkbox" class="intervention" value="ADL Training" checked onchange="saveInterventions()" /> ADL Training</label>
    </div>

    <button onclick="generateSummary()">Generate Summary</button>

    <textarea id="summaryOutput" readonly placeholder="Generated summary will appear here..."></textarea>
    <button onclick="copySummary()">Copy Summary</button>
  </div>

  <script>
    const correctPin = '1234';
    const patients = [];
    for(let i=101; i<=135; i++) { patients.push('Room ' + i); }

    const tasks = [
      'Eating',
      'Oral Hygiene',
      'Upper Body Dressing',
      'Lower Body Dressing',
      'Footwear',
      'Shower',
      'Toilet Hygiene',
      'Toilet Transfers'
    ];

    const scores = {
      1: 'Dependent',
      2: 'Substantial A',
      3: 'Partial A',
      4: 'Supervision/Touch A',
      5: 'Setup A',
      6: 'Independent',
      88: 'Not Attempted',
      9: 'Not Applicable',  // stored as 9 but displayed as 09
      7: 'Refused'
    };

    // Defaults for first load eval scores:
    const defaultEvalScores = {
      'Eating': '4',
      'Oral Hygiene': '4',
      'Shower': '2',
      'Upper Body Dressing': '4',
      'Lower Body Dressing': '2',
      'Toilet Transfers': '3',
      'Toilet Hygiene': '2'
      // Footwear no default, blank
    };
    const defaultDischargeScore = '6';

    let currentPatient = null;

    function login() {
      const pin = document.getElementById('pinInput').value;
      if (pin === correctPin) {
        document.getElementById('app').style.display = 'block';
        initPatientSelector();
      } else {
        alert('Incorrect PIN');
      }
    }

    function initPatientSelector() {
      const selector = document.getElementById('patientSelector');
      selector.innerHTML = '';
      patients.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        selector.appendChild(opt);
      });
      // Select first patient by default
      selector.value = patients[0];
      currentPatient = patients[0];
      renderTasks();
      loadPatientData(currentPatient);
      loadOtherData();
    }

    function onPatientChange() {
      const selector = document.getElementById('patientSelector');
      currentPatient = selector.value;
      clearSummary();
      renderTasks();
      loadPatientData(currentPatient);
      loadOtherData();
    }

    function renderTasks() {
      const tasksDiv = document.getElementById('tasks');
      tasksDiv.innerHTML = '';
      tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `<strong>${task}</strong>
          <div class="scores">
            <label>Eval Score: 
              <select class="evalScore">${scoreOptions()}</select>
            </label>
            <label>Discharge Goal: 
              <select class="dischargeScore">${scoreOptions()}</select>
            </label>
            <label>Current Score: 
              <select class="currentScore">${scoreOptions()}</select>
            </label>
          </div>`;
        tasksDiv.appendChild(div);

        // Add onchange listeners to save scores
        div.querySelector('.evalScore').onchange = () => {
          saveScore(currentPatient, task, 'eval', div.querySelector('.evalScore').value);
        };
        div.querySelector('.dischargeScore').onchange = () => {
          saveScore(currentPatient, task, 'discharge', div.querySelector('.dischargeScore').value);
        };
        div.querySelector('.currentScore').onchange = () => {
          saveScore(currentPatient, task, 'current', div.querySelector('.currentScore').value);
        };
      });
    }

    function scoreOptions() {
      // Display '09' instead of '9' for Not Applicable
      return Object.entries(scores)
        .map(([val, label]) => {
          let displayVal = val;
          if(val === '9' || val === 9) displayVal = '09';
          return `<option value="${val}">${displayVal} - ${label}</option>`;
        })
        .join('');
    }

    // localStorage keys:
    // QI scores: 'qi_{patient}_{task}_{type}'
    // Other data keys: 'qi_{patient}_goal', 'qi_{patient}_progress', 'qi_{patient}_barriers', 'qi_{patient}_interventions'

    function saveScore(patient, task, type, val) {
      localStorage.setItem(`qi_${patient}_${task}_${type}`, val);
    }

    function loadScore(patient, task, type) {
      return localStorage.getItem(`qi_${patient}_${task}_${type}`);
    }

    function loadPatientData(patient) {
      const tasksDiv = document.getElementById('tasks');
      const taskDivs = tasksDiv.getElementsByClassName('task');

      for (const div of taskDivs) {
        const taskName = div.querySelector('strong').textContent;

        // Load Eval or default and save default if first time
        let evalVal = loadScore(patient, taskName, 'eval');
        if (!evalVal) {
          evalVal = defaultEvalScores[taskName] || '';
          if(evalVal) saveScore(patient, taskName, 'eval', evalVal);
        }
        div.querySelector('.evalScore').value = evalVal;

        // Load Discharge or default 6
        let dischargeVal = loadScore(patient, taskName, 'discharge');
        if (!dischargeVal) {
          dischargeVal = defaultDischargeScore;
          saveScore(patient, taskName, 'discharge', dischargeVal);
        }
        div.querySelector('.dischargeScore').value = dischargeVal;

        // Load current score or blank
        const currentVal = loadScore(patient, taskName, 'current');
        if(currentVal) div.querySelector('.currentScore').value = currentVal;
      }
    }

    // Other persistent data: patientGoal, progressStatus, barriers, interventions

    function savePatientGoal() {
      localStorage.setItem(`qi_${currentPatient}_goal`, document.getElementById('patientGoal').value);
    }
    function loadPatientGoal() {
      return localStorage.getItem(`qi_${currentPatient}_goal`) || '';
    }

    function saveProgressStatus() {
      const radios = document.getElementsByName('progressStatus');
      let val = 'Progressing';
      radios.forEach(radio => { if(radio.checked) val = radio.value; });
      localStorage.setItem(`qi_${currentPatient}_progress`, val);
    }
    function loadProgressStatus() {
      return localStorage.getItem(`qi_${currentPatient}_progress`) || 'Progressing';
    }

    function saveBarriers() {
      const checked = [...document.querySelectorAll('.barrier:checked')].map(c => c.value);
      localStorage.setItem(`qi_${currentPatient}_barriers`, JSON.stringify(checked));
    }
    function loadBarriers() {
      const val = localStorage.getItem(`qi_${currentPatient}_barriers`);
      if(!val) return ['Weakness', 'Deconditioning', 'Balance Impairment', 'Limited ROM', 'Pain'];
      try {
        return JSON.parse(val);
      } catch {
        return ['Weakness', 'Deconditioning', 'Balance Impairment', 'Limited ROM', 'Pain'];
      }
    }

    function saveInterventions() {
      const checked = [...document.querySelectorAll('.intervention:checked')].map(c => c.value);
      localStorage.setItem(`qi_${currentPatient}_interventions`, JSON.stringify(checked));
    }
    function loadInterventions() {
      const val = localStorage.getItem(`qi_${currentPatient}_interventions`);
      if(!val) return ['Therapeutic Exercise', 'Therapeutic Activity', 'ADL Training'];
      try {
        return JSON.parse(val);
      } catch {
        return ['Therapeutic Exercise', 'Therapeutic Activity', 'ADL Training'];
      }
    }

    function loadOtherData() {
      // Load Patient Goal
      document.getElementById('patientGoal').value = loadPatientGoal();

      // Load Progress Status
      const progressVal = loadProgressStatus();
      const radios = document.getElementsByName('progressStatus');
      radios.forEach(radio => radio.checked = (radio.value === progressVal));

      // Load Barriers
      const barriers = loadBarriers();
      document.querySelectorAll('.barrier').forEach(cb => {
        cb.checked = barriers.includes(cb.value);
      });

      // Load Interventions
      const interventions = loadInterventions();
      document.querySelectorAll('.intervention').forEach(cb => {
        cb.checked = interventions.includes(cb.value);
      });
    }

    function generateSummary() {
      const tasksDiv = document.getElementById('tasks');
      const taskDivs = tasksDiv.getElementsByClassName('task');

      let summary = '';

      summary += 'EVAL SCORES:\n';
      for (const div of taskDivs) {
        const taskName = div.querySelector('strong').textContent;
        const evalVal = div.querySelector('.evalScore').value;
        const evalLabel = scores[evalVal] || evalVal;
        summary += `  ${taskName}: ${evalVal === '9' ? '09' : evalVal} - ${evalLabel}\n`;
      }

      summary += '\nDISCHARGE GOALS:\n';
      for (const div of taskDivs) {
        const taskName = div.querySelector('strong').textContent;
        const disVal = div.querySelector('.dischargeScore').value;
        const disLabel = scores[disVal] || disVal;
        summary += `  ${taskName}: ${disVal === '9' ? '09' : disVal} - ${disLabel}\n`;
      }

      summary += '\nCURRENT SCORES:\n';
      for (const div of taskDivs) {
        const taskName = div.querySelector('strong').textContent;
        const curVal = div.querySelector('.currentScore').value;
        const curLabel = scores[curVal] || curVal;
        summary += `  ${taskName}: ${curVal === '9' ? '09' : curVal} - ${curLabel}\n`;
      }

      // Patient Goal
      const patientGoal = document.getElementById('patientGoal').value.trim();
      if (patientGoal) {
        summary += `\nPATIENT GOAL:\n  ${patientGoal}\n`;
      }

      // Progress Status
      const progressElems = document.getElementsByName('progressStatus');
      let progressStatus = 'Progressing';
      for (const el of progressElems) {
        if (el.checked) {
          progressStatus = el.value;
          break;
        }
      }
      summary += `\nPROGRESS STATUS: ${progressStatus}\n`;

      // Barriers
      const barrierElems = document.querySelectorAll('.barrier');
      const selectedBarriers = [];
      barrierElems.forEach(el => {
        if (el.checked) selectedBarriers.push(el.value);
      });
      summary += `\nBARRIERS TO GOALS: ${selectedBarriers.join(', ') || 'None'}\n`;

      // Interventions
      const interventionElems = document.querySelectorAll('.intervention');
      const selectedInterventions = [];
      interventionElems.forEach(el => {
        if (el.checked) selectedInterventions.push(el.value);
      });
      summary += `\nINTERVENTIONS: ${selectedInterventions.join(', ') || 'None'}\n`;

      document.getElementById('summaryOutput').value = summary;
    }

    function copySummary() {
      const summaryText = document.getElementById('summaryOutput').value;
      if (!summaryText) {
        alert('Please generate the summary first.');
        return;
      }
      navigator.clipboard.writeText(summaryText)
        .then(() => alert('Summary copied to clipboard!'))
        .catch(() => alert('Failed to copy summary.'));
    }

  </script>
</body>
</html>
